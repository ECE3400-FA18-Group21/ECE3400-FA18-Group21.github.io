<!DOCTYPE html>
<!-- ECE 3400 | Fall 2018
website for Team 21
Created: 08/29/2018
Updated: 11/29/2018 -->

<html lang="en">

  <head>
    <meta name="referrer" content="origin">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Used to document the work of Team 21 during the
    Fall 2018 semester of ECE 3400: Intelligent Physical Systems at Cornell University">
    <meta name="keywords" content="Cornell, Engineering, ECE 3400, Robotics, Maze, Win">
    <meta name="author" content="​Brian Richard, Eric Lei, Kenneth Fang, Tyler Sherman">

    <title>ECE 3400 | Fall 2018 - Team 21</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom fonts for this template -->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Kaushan+Script' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700' rel='stylesheet' type='text/css'>

    <!-- Custom styles for this template -->
    <link href="css/agency.css" rel="stylesheet">
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js?skin=desert"></script>

    <!--favicon support for all modern browsers / mobile devices-->
    <link rel="apple-touch-icon" sizes="180x180" href="img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon/favicon-16x16.png">
    <link rel="manifest" href="img/favicon/site.webmanifest">
    <link rel="mask-icon" href="img/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="img/favicon/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="img/favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

  </head>


  <body id="page-top">

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" id="mainNav">
      <div class="container">
        <a class="navbar-brand js-scroll-trigger" href="#page-top">ECE 3400 - Team 21</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          Menu
          <i class="fas fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav text-uppercase ml-auto">
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="index.html">Home</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Milestones
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                <a class="dropdown-item" href="milestone1.html#report">Milestone 1</a>
                <a class="dropdown-item" href="milestone2.html#report">Milestone 2</a>
                <a class="dropdown-item" href="milestone3.html#report">Milestone 3</a>
                <a class="dropdown-item" href="milestone4.html#report">Milestone 4</a>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Labs
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                <a class="dropdown-item" href="lab1.html#report">Lab 1</a>
                <a class="dropdown-item" href="lab2.html#report">Lab 2</a>
                <a class="dropdown-item" href="lab3.html#report">Lab 3</a>
                <a class="dropdown-item" href="lab4.html#report">Lab 4</a>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Links
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                <a class="dropdown-item" href="team-contract.html#contract">Team Contract</a>
                <a class="dropdown-item" href="meeting-minutes.html#minutes">Meeting Minutes</a>
                <a class="dropdown-item" href="ethics.html#assignment">Ethics Homework</a>
              </div>
            </li>
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" target="_blank" href="https://github.com/ECE3400-FA18-Group21/ECE3400-FA18-Group21.github.io/tree/master">Github</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Header -->
    <header class="masthead">
      <div class="container">
        <div class="intro-text">
          <div class="intro-lead-in">Lab 4</div>
          <div class="intro-heading text-uppercase">FPGA &amp; Shape Detection</div>
          <a class="btn btn-primary btn-xl text-uppercase js-scroll-trigger" href="#report">Read The Report</a>
        </div>
      </div>
    </header>

    <!--THIS IS WHERE THE TEXT WILL GO-->
    <div class="container" id="report">
      <br><br>
      <h1 class="page-header text-center">Lab 4</h1>
      <hr>
      <h4 class="page-header text-left">Lab Goals</h4>
      <p>
        The overall goal for this lab is to build a system that can
        detect treasurers of different shapes and colors.
        This consists of the following parts:
        <ul>
          <li>Arduino-Camera communication</li>
          <li>Arduino-FPGA communication</li>
          <li>Camera-FPGA communication</li>
          <li>Color detection with the FPGA, Camera, and Arduino</li>
        </ul>
      </p>
      <h4 class="page-header text-left">Prelab Questions</h4>
      <ol class="list-bullet">
      	<li><u>From the FPGA’s specifications, what is the maximum size of the
          buffer you can create? Given that each entry is ___, how many
          entries large can the RAM be?</u></li>
          <ul>
              <li>Total RAM = 594 Kbits = 74250 bytes</li>
          </ul>
        <li><u>The OV7670 offers a variety of pixels formats to sample data.
          Which of the formats available provides the most info on the base
          colors making up each pixel?</u></li>
          <ul>
              <li>Image sensor can output the following:</li>
              <ul>
                  <li>QCIF 176 x 144 = 24768 bytes can fit</li>
                  <li>YUV/YCbCr 4:2:2</li>
                  <li>RGB565/555</li>
                  <li>GRB 4:2:2</li>
                  <li>Raw RGB Data</li>
              </ul>
              <li>Use RGB565 since it maintains the most information</li>
          </ul>
        <li><u>Given that the input to the VGA adapter is RGB332, how can you
          convert (downsize) the pixel format from Q2 to be accepted by the
          VGA module?</u></li>
          <ul>
              <li>Starting with the RGB565 pixel format, take the most significant
                bits to downsample to the VGA-accepted RGB332 format</li>
          </ul>
        <li><u>Now that you know the downsized memory per pixel (from Q3), you
          need to know how many you can fit into memory. Which of the
          predefined resolutions that the OV7670 supports provides the max
          amount of pixels in an image, given the constrained max size of
          the buffer (from Q1)? What’s the size of the buffer?</u></li>
          <ul>
              <li>QCIF 176 x 144 = 24768 bytes can fit</li>
          </ul>
        <li><u>Using the Register Set table on pages 10-23 of the OV7670
          datasheet, find the registers you will need to set.</u></li>
          <ul>
              <li>Please see the <a href="#Arduino">Arduino</a> section below</li>
          </ul>
        <li><u>Take a look at the timing diagrams (Fig 5 and 6) on Page 7
          (Ignore HSYNC, you won’t use it). Use both diagrams to determine
          when you should sample your data. (Hint: You only want to sample
          valid bytes, and each one only once)</u></li>
          <ul>
              <li>HREF signal is high during readout of a single row, and low in between readouts of rows</li>
              <li>VSYNC is set high after all rows of a single frame have been read out, signaling the start of a new frame</li>
              <li>RGB565 uses 16 bits to represent a single pixel, so requires two cycles to output since the camera outputs 8 bits in parallel per cycle</li>
              <li>Data is fully valid every other cycle when HREF is asserted</li>
              <li>Timing diagrams shown below in Downsampler portion of the FPGA section</li>
          </ul>
        <li><u>Discuss with your entire team, what method you want to use to
          communicate information from the FPGA to the Arduino. Parallel?
          Serial?</u></li>
          <ul>
              <li>For this lab, we are going to use parallel communication</li>
              <ul>
                <li>We have open pins on the Arduino we are using</li>
                <li>Easy to implement</li>
              </ul>
              <li>For the actual implementation on the robot, we are going to use software-serial</li>
              <ul>
                <li>We have a pin-shortage</li>
              </ul>
          </ul>
      </ol>
      <h4 class="page-header text-left">Sub-Teams</h4>
      <p>To begin, we split into two groups of two. Each group progressed
        through the lab individually, as described below.
      </p>
      <ul class="list-bullet">
        <li>Arduino &amp; Camera Team = Kenneth and Tyler</li>
        <li>FPGA Team = Brian and Eric</li>
      </ul>
      <hr>
      <h3 class="page-header text-center" id="Arduino">Arduino &amp; Camera Team</h3>
      <p><u>GOAL: setup the camera and create an FPGA-Arduino communication protocol</u></p>
      <h4 class="page-header text-left">Materials Used</h4>
      <ul class="list-bullet">
      	<li>1 × Arduino Uno</li>
        <li>1 × <a target="_blank" href="http://web.mit.edu/6.111/www/f2016/tools/OV7670_2006.pdf">OV7670 CMOS Image Sensor</a></li>
        <li>1 × 3V Regulator</li>
        <li>2 × 10 kΩ Resistors</li>
        <li>2 × 4.7 μF Polarized Capacitors</li>
        <li>1 × mini-breadboard</li>
      </ul>
      <h4 class="page-header text-left">Wiring Arduino-to-Camera</h4>
      <ul>
        <li>First, we <b>DISABLED INTERNAL PULL-UPS ON ARDUINO</b></li>
        <ul>
          <li>Tyler discovered how to do this on Mac (see Piazza post)</li>
          <li>Without this, the I2C signals would be pulled up to 5V, which would break the camera</li>
        </ul>
        <li>We wired a 5V input from the Arduino to a 3.3V regulator, with capacitors on the 5V input and 3.3V output to stabilize the power supply</li>
        <ul>
          <li>NOTE - the regulator’s output will not be 3.3V unless it is loaded</li>
          <li>For testing our regulator we added a 330 Ω resistor and measured the output pin</li>
        </ul>
        <li>We wired up the schematic provided in the lab, which sets up I2C communication with the camera for programming</li>
        <ul>
          <li>NOTE - pin names on the camera differ from the diagram below</li>
          <ul>
            <li>SIOC = SCL</li>
            <li>SIOD = SDA</li>
            <li>MCLK = XCLK</li>
          </ul>
        </ul>
      </ul>
      <p>Credit to Kirstin for both schematic diagrams</p>
      <div class="container">
        <div class="row">
          <div class="col-md-4">
            <div class="thumbnail">
              <img src="img/lab4/Camera-to-Arduino_3V.jpg" style="width:100%">
              <div class="caption text-center">
                <p>Camera-to-Arduino power schematic</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="thumbnail">
              <img src="img/lab4/Camera-to-Arduino_I2C.png" style="width:65%">
              <div class="caption text-left">
                <p>Camera-to-Arduino I2C schematic</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="thumbnail">
              <img src="img/lab4/Wiring.jpeg" style="width:80%">
              <div class="caption text-center">
                <p>Full system wiring &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <h4 class="page-header text-left">Programming the Camera</h4>
      <ul>
        <li>The camera has control registers defined by their Serial Camera
          Control Bus (SCCB) interface</li>
        <li>We can use this interface via I2C from the Arduino</li>
        <li>Here are the control bits we need to set, and in which register
          (the format is REGISTER_NAME[bit_index], bits are 0-indexed):</li>
          <ul>
            <div class="row">
              <div class="col-md-2">
                <li>COM7[7] = 1</li>
                <li>COM7[3] = 1</li>
                <li>COM7[2],[0] = 1, 1</li>
                <li>COM7[1] = 1</li>
                <li>COM3[3] = 1</li>
                <li>COM9[6:4] = 000</li>
                <li>COM9[0] = 1</li>
                <li>COM15[7:6] = 11</li>
                <li>COM15[5:4] = 01</li>
                <li>COM17[3] = 1</li>
                <li>CLKRC[7] = 1</li>
                <li>CLKRC[6] = 1</li>
                <li>MVFP[5] = 1</li>
                <li>MVFP[4] = 1</li>
              </div>
              <div class="col-md-10">
                ← SCCB register reset<br>
                ← Output format - QCIF selection<br>
                ← Output format - RGB selection<br>
                ← Color bar enable<br>
                ← Scale enable<br>
                ← Automatic Gain Ceiling (2x)<br>
                ← Freeze AGC/AEC<br>
                ← Data format - output full range enable<br>
                ← RGB 565 enable<br>
                ← DSP color bar enable<br>
                ← Enable digital PLL option<br>
                ← Use external clock directly<br>
                ← Mirror image enable<br>
                ← VFlip enable<br>
              </div>
            </div>
          </ul>
        <li>The camera I2C slave addresses are found on page 10 of the camera datasheet</li>
        <ul>
          <li>0x42 = write address</li>
          <li>0x43 = read address</li>
          <li>NOTE - Arduino’s Wire library fills in the LSB based on whether we are reading or writing</li>
          <ul>
            <li>The actual address we use when calling the Wire library is 0x21 (the 7 MSB of the above slave addresses</li>
          </ul>
        </ul>
        <li>NOTE - all values will be read in hexadecimal format</li>
        <ul>
          <li>All addresses and write values should also be written in hex</li>
          <li>Be sure you specify that format in your code (eg. 0xAB)</li>
        </ul>
        <li>We used the provided read_register_value() function to create a function read_key_registers()</li>
        <ul>
          <li>We use this as a diagnostic tool to print out the values in all of the target registers</li>
          <li>It is the first function called, and then is called again after writing to the registers</li>
          <li>This allows us to compare the results to make sure we set the correct registers to the desired value</li>
        </ul>
      </ul>
      <div class="container">
        <div class="row">
          <div class="col-md-4">
          </div>
          <div class="col-md-4">
            <div class="thumbnail">
              <img src="img/lab4/Camera_Setup.png" style="width:100%">
              <div class="caption text-center">
                <p>Setting up the camera registers</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
          </div>
        </div>
      </div>
      <h4 class="page-header text-left">Creating FPGA-to-Camera Communication Scheme</h4>
      <ul>
        <li>For the competition, we need to be able to detect the following:</li>
        <ul>
          <li>Presence of a treasure</li>
          <li>Color detection - blue or red</li>
          <li>Shape detection - triangle, square, or circle</li>
        </ul>
        <li>We created the below table to encode this information into 1 byte</li>
        <ul>
          <li>Although we are using a full byte, the 7 possibilities fit into just 3 bits</li>
        </ul>
        <li>In Lab 4, we only need to be able to detect color: Red or Blue</li>
        <ul>
          <li>This is easily done with one wire from a GPIO pin on the FPGA to a
            digital I/O pin on the Arduino</li>
        </ul>
        <li>During the competition, when we need to transmit three bits at a time,
          we plan to use software serial</li>
        <ul>
          <li>This is more challenging to setup</li>
          <li>Only requires two pins -> we only have two pins available</li>
        </ul>
      </ul>
      <div class="container">
        <div class="row">
          <div class="col-md-4">
          </div>
          <div class="col-md-4">
            <div class="thumbnail">
              <img src="img/lab4/FPGA-to-Camera Encoding.png" style="width:100%">
              <div class="caption text-center">
                <p>FPGA-to-Arduino communication scheme</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
          </div>
        </div>
      </div>
      <hr>
      <h3 class="page-header text-center">FPGA Team</h3>
      <p><u>GOAL: setup the FPGA to perform shape and color detection</u></p>
      <h4 class="page-header text-left">Materials Used</h4>
      <ul class="list-bullet">
      	<li>1 × <a target="_blank" href="https://www.terasic.com.tw/cgi-bin/page/archive_download.pl?Language=English&No=593&FID=75023fa36c9bf8639384f942e65a46f3">DE0-Nano Development and Education Board</a></li>
        <li>1 × GPIO-to-VGA adapter</li>
        <li>Altera Quartus Software</li>
      </ul>

      <h4 class="page-header text-left">PLL and Clocks</h4>
      <ul>
        <li>Created a Phase-Locked Loop (PLL)
        <ul>
            <li>Takes a 50 MHz clock input</li>
            <li>Outputs 24 MHz, 25 MHz, and 50 MHz clocks</li>
        </ul>
        <li>The 24 MHz clock is used to drive the camera</li>
        <li>The 25 MHz clock is used for the downsampler, image processor, and VGA driver</li>
      </ul>
      <h4 class="page-header text-left">Buffer Reader</h4>
      <ul>
        <li>Display test pattern across the VGA Driver by writing a test array to
          memory and reading from it</li>
        <li>Update the X_ADDR and Y_ADDR, since these form the write address in
          memory corresponding to the pixel that is to be displayed</li>
          <ul>
              <li>If X_ADDR < 50, write a green pixel</li>
              <li>Else if X_ADDR < 80, write a blue pixel</li>
              <li>Else write a red pixel</li>
          </ul>
        <li>Once this is written to memory, VGA driver continuously reads all the
          pixel values in memory and displays them</li>
      </ul>
      <div class="container">
        <div class="row">
          <div class="col-md-4">
          </div>
          <div class="col-md-4">
            <div class="thumbnail">
              <img src="img/lab4/testImage.jpg" style="width:100%">
              <div class="caption text-center">
                <p>Buffer reader test image</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
          </div>
        </div>
      </div>
      <h4 class="page-header text-left">Downsampler</h4>
      <ul>
        <li>The camera is set up to output RGB565 pixel format, thus there are:</li>
        <ul>
        	<li>5 bits for the red channel</li>
        	<li>6 bits for the green channel</li>
         	<li>5 buts for the blue channel</li>
        	<li>A total of 16 bits per image</li>
        </ul>
        <li>Since the camera outputs 8 bits in parallel at a time per pixel,
          2 clock cycles are needed to output all 16 bits that represent a
          single pixel</li>
        <li>The output is broken up as follows:</li>
        <ul>
        	<li>Byte on first cycle = 5 bits of red + 3 bits of green</li>
        	<li>Byte on second cycle = 3 bits of green + 5 bits of blue</li>
         	<li>See the <i>RGB565 timing diagram</i> below for more information</li>
        </ul>
        <li>To downsample to RGB332, simply take the 3 MSB’s of red, 3 MSB’s of
          green, and 2 MSB’s of blue</li>
        <li>HREF signal is asserted during a readout of an entire row of pixels,
          and is low in between row readouts</li>
        <li>After all rows have been readout in a single frame, VSYNC is asserted</li>
        <ul>
        	<li>See the <i>VGA frame timing diagram</i> below for more information
        </ul>
        <li>Every two cycles of PCLK (clock at which pixels are readout from camera):
        <ul>
        	<li>a valid RGB332 pixel value is produced</li>
        	<li>W_EN needs to be asserted</li>
        </ul>
        <li>In top level, use readout sequence with HREF and VSYNC to determine
          the address in memory that needs to be written to during readout and
          when it is to be incremented</li>
      </ul>
      <div class="container">
        <div class="row">
          <div class="col-md-2">
          </div>
          <div class="col-md-4">
            <div class="thumbnail">
              <img src="img/lab4/rgb565Timing.png" style="width:75%">
              <div class="caption text-center">
                <p>RGB565 timing diagram</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="thumbnail">
              <img src="img/lab4/frameTiming.png" style="width:100%">
              <div class="caption text-center">
                <p>VGA frame timing diagram</p>
              </div>
            </div>
          </div>
          <div class="col-md-2">
          </div>
        </div>
      </div>
      <h4 class="page-header text-left">Color Detection</h4>
      <ul>
        <li>For this lab, the color detection task consisted of determining
          whether a given image was primarily blue or primarily red</li>
        <ul>
        	<li>Determine this by counting frequency of pixels with an R value >
            B value</li>
        </ul>
        <li>Every VGA clock cycle, the image processing block reads a new pixel
          from memory
        <li>The downsampler stores three bits of red information and two bits
          of blue information</li>
        <li>Given this, we count the number of times the two most significant
          bits of red are greater than the two most significant bits of blue</li>
        <ul>
        	<li>If this counter exceeds half the number of pixels in the image
            (12672) by the end of the frame, the image was majority red</li>
        </ul>
        <li>Every time VSYNC rises to signal a new frame, we update an output
          pin according to:</li>
        <ul>
        	<li>Majority red = HIGH</li>
        	<li>Majority blue = LOW</li>
        </ul>
      </ul>
    <hr>
    <h3 class="page-header text-center">Full System Testing</h3>
    <p>This video demonstration shows our robot completing all required behaviors:</p>
    <ul>
      <li>Uses the camera to capture a live image</li>
      <li>Downsamples that image from RGB565 to RGB332 on the FPGA</li>
      <li>Displays that image on the monitor through the VGA adapter</li>
      <li>The FPGA processes the data to determine if the image is red or blue</li>
      <li>The FPGA transmits that information to the Arduino</li>
      <li>The Arduino prints the results onto the Serial monitor</li>
    </ul>
    <div class="embed-responsive embed-responsive-21by9">
      <iframe width="560" height="315" src="https://www.youtube.com/embed/JfasRdmIlkU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
    </div>
  </div>




    <!-- Footer -->
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-md-3">
          </div>
          <div class="col-md-6">
            <span class="copyright">Copyright &copy; 2018, Team 21 of ECE 3400 | Fall 2018.
              <br>
              Theme Made Using <a target="_blank" href="http://getbootstrap.com">Bootstrap
            </span>
          </div>
          <div class="col-md-3">
            <ul class="list-inline quicklinks">
              <li class="list-inline-item">
                <a target="_blank" href="https://cei-lab.github.io/ece3400-2018/">ECE 3400 Course Page</a>
              </li>
            </ul>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4">
          </div>
          <div class="col-md-4">
            <ul class="list-inline social-buttons">
              <li class="list-inline-item">
                <a target="_blank" href="https://github.com/ECE3400-FA18-Group21/ECE3400-FA18-Group21.github.io/tree/master">
                  <i class="fab fa-github"></i>
                </a>
              </li>
            </ul>
          </div>
          <div class="col-md-4">
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Contact form JavaScript -->
    <script src="js/jqBootstrapValidation.js"></script>
    <script src="js/contact_me.js"></script>

    <!-- Custom scripts for this template -->
    <script src="js/agency.min.js"></script>

  </body>

</html>
