<!DOCTYPE html>
<!-- ECE 3400 | Fall 2018
website for Team 21
Created: 08/29/2018
Updated: 11/02/2018 -->
<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js?skin=desert"></script>

<html lang="en">

  <head>
    <meta name="referrer" content="origin">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Used to document the work of Team 21 during the
    Fall 2018 semester of ECE 3400: Intelligent Physical Systems at Cornell University">
    <meta name="keywords" content="Cornell, Engineering, ECE 3400, Robotics, Maze, Win">
    <meta name="author" content="​Brian Richard, Eric Lei, Kenneth Fang, Tyler Sherman">

    <title>ECE 3400 | Fall 2018 - Team 21</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom fonts for this template -->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Kaushan+Script' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700' rel='stylesheet' type='text/css'>

    <!-- Custom styles for this template -->
    <link href="css/agency.css" rel="stylesheet">

    <!--favicon support for all modern browsers / mobile devices-->
    <link rel="apple-touch-icon" sizes="180x180" href="img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon/favicon-16x16.png">
    <link rel="manifest" href="img/favicon/site.webmanifest">
    <link rel="mask-icon" href="img/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="img/favicon/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="img/favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

  </head>


  <body id="page-top">

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" id="mainNav">
      <div class="container">
        <a class="navbar-brand js-scroll-trigger" href="#page-top">ECE 3400 - Team 21</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          Menu
          <i class="fas fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav text-uppercase ml-auto">
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="index.html">Home</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Milestones
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                <a class="dropdown-item" href="milestone1.html#report">Milestone 1</a>
                <a class="dropdown-item" href="milestone2.html#report">Milestone 2</a>
                <a class="dropdown-item" href="milestone3.html#report">Milestone 3</a>
                <a class="dropdown-item" href="milestone4.html#report">Milestone 4</a>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Labs
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                <a class="dropdown-item" href="lab1.html#report">Lab 1</a>
                <a class="dropdown-item" href="lab2.html#report">Lab 2</a>
                <a class="dropdown-item" href="lab3.html#report">Lab 3</a>
                <a class="dropdown-item" href="lab4.html#report">Lab 4</a>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Links
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                <a class="dropdown-item" href="team-contract.html#contract">Team Contract</a>
                <a class="dropdown-item" href="meeting-minutes.html#minutes">Meeting Minutes</a>
                <a class="dropdown-item" href="#">TBD 3</a>
                <a class="dropdown-item" href="#">TBD 4</a>
              </div>
            </li>
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" target="_blank" href="https://github.com/ECE3400-FA18-Group21/ECE3400-FA18-Group21.github.io/tree/master">Github</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Header -->
    <header class="masthead">
      <div class="container">
        <div class="intro-text">
          <div class="intro-lead-in">Lab 4</div>
          <div class="intro-heading text-uppercase">FPGA &amp; Shape Detection</div>
          <a class="btn btn-primary btn-xl text-uppercase js-scroll-trigger" href="#report">Read The Report</a>
        </div>
      </div>
    </header>

    <!--THIS IS WHERE THE TEXT WILL GO-->
    <div class="container" id="report">
      <br><br>
      <h1 class="page-header text-center">Lab 4</h1>
      <hr>
      <h4 class="page-header text-left">Lab Goals</h4>
      <p>
        The overall goal for this lab is to build a system that can
        detect treasurers of different shapes and colors.
        This consists of the following parts:
        <ul>
          <li>Arduino-Camera communication</li>
          <li>Arduino-FPGA communication</li>
          <li>Camera-FPGA communication</li>
          <li>Color detection with the FPGA, Camera, and Arduino</li>
        </ul>
      </p>
      <h4 class="page-header text-left">Prelab Questions</h4>
      <ol class="list-bullet">
      	<li><u>From the FPGA’s specifications, what is the maximum size of the
          buffer you can create? Given that each entry is ___, how many
          entries large can the RAM be?</u></li>
          <ul>
              <li>Total RAM = 594 Kbits = 74250 bytes</li>
          </ul>
        <li><u>The OV7670 offers a variety of pixels formats to sample data.
          Which of the formats available provides the most info on the base
          colors making up each pixel?</u></li>
          <ul>
              <li>Image sensor can output the following:</li>
              <ul>
                  <li>QCIF 176 x 144 = 24768 bytes can fit</li>
                  <li>YUV/YCbCr 4:2:2</li>
                  <li>RGB565/555</li>
                  <li>GRB 4:2:2</li>
                  <li>Raw RGB Data</li>
              </ul>
              <li>Use RGB565 since it maintains the most information</li>
          </ul>
        <li><u>Given that the input to the VGA adapter is RGB332, how can you
          convert (downsize) the pixel format from Q2 to be accepted by the
          VGA module?</u></li>
          <ul>
              <li>Starting with the RGB565 pixel format, take the most significant
                bits to downsample to the VGA-accepted RGB332 format</li>
          </ul>
        <li><u>Now that you know the downsized memory per pixel (from Q3), you
          need to know how many you can fit into memory. Which of the
          predefined resolutions that the OV7670 supports provides the max
          amount of pixels in an image, given the constrained max size of
          the buffer (from Q1)? What’s the size of the buffer?</u></li>
          <ul>
              <li>QCIF 176 x 144 = 24768 bytes can fit</li>
          </ul>
        <li><u>Using the Register Set table on pages 10-23 of the OV7670
          datasheet, find the registers you will need to set.</u></li>
          <ul>
              <li>Please see the <a href="#Arduino">Arduino</a> section below</li>
          </ul>
        <li><u>Take a look at the timing diagrams (Fig 5 and 6) on Page 7
          (Ignore HSYNC, you won’t use it). Use both diagrams to determine
          when you should sample your data. (Hint: You only want to sample
          valid bytes, and each one only once)</u></li>
          <ul>
              <li>HREF signal is high during readout of a single row, and low in between readouts of rows</li>
              <li>VSYNC is set high after all rows of a single frame have been read out, signaling the start of a new frame</li>
              <li>RGB565 uses 16 bits to represent a single pixel, so requires two cycles to output since the camera outputs 8 bits in parallel per cycle</li>
              <li>Data is fully valid every other cycle when HREF is asserted</li>
              <li>Timing diagrams shown below in Downsampler portion of the FPGA section</li>
          </ul>
        <li><u>Discuss with your entire team, what method you want to use to
          communicate information from the FPGA to the Arduino. Parallel?
          Serial?</u></li>
          <ul>
              <li>For this lab, we are going to use parallel communication</li>
              <ul>
                <li>We have open pins on the Arduino we are using</li>
                <li>Easy to implement with just 3 wires</li>
              </ul>
              <li>For the actual implementation on the robot, we are going to use software-serial</li>
              <ul>
                <li>We have a pin-shortage</li>
              </ul>
          </ul>
      </ol>
      <h4 class="page-header text-left">Sub-Teams</h4>
      <p>To begin, we split into two groups of two. Each group progressed
        through the lab individually, as described below.
      </p>
      <ul class="list-bullet">
        <li>Arduino &amp; Camera Team = Kenneth and Tyler</li>
        <li>FPGA Team = Brian and Eric</li>
      </ul>
      <hr>
      <h3 class="page-header text-center" id="Arduino">Arduino &amp; Camera Team</h3>
      <p><u>GOAL: setup the camera and create an FPGA-Arduino communication protocol</u></p>
      <h4 class="page-header text-left">Materials Used</h4>
      <ul class="list-bullet">
      	<li>1 × Arduino Uno</li>
        <li>1 × <a target="_blank" href="https://www.voti.nl/docs/OV7670.pdf">OV7670 CMOS Image Sensor</a></li>
        <li>1 × 3V Regulator</li>
        <li>2 × 10 kΩ Resistors</li>
        <li>2 × 4.7 μF Polarized Capacitors</li>
        <li>1 × mini-breadboard</li>
      </ul>
      <h4 class="page-header text-left">Wiring Arduino-to-Camera</h4>
      <ul>
        <li>First, we <b>DISABLED INTERNAL PULL-UPS ON ARDUINO</b></li>
        <ul>
          <li>Tyler discovered how to do this on Mac (see Piazza post)</li>
          <li>Without this, the I2C signals would be pulled up to 5V, which would break the camera</li>
        </ul>
        <li>We wired a 5V input from the Arduino to a 3.3V regulator, with capacitors on the 5V input and 3.3V output to stabilize the power supply</li>
        <ul>
          <li>NOTE - the regulator’s output will not be 3.3V unless it is loaded</li>
          <li>For testing our regulator we added a 330 Ω resistor and measured the output pin</li>
        </ul>
        <li>We wired up the schematic provided in the lab, which sets up I2C communication with the camera for programming</li>
        <ul>
          <li>NOTE - pin names on the camera differ from the diagram below</li>
          <ul>
            <li>SIOC = SCL</li>
            <li>SIOD = SDA</li>
            <li>MCLK = XCLK</li>
          </ul>
        </ul>
      </ul>
      <p>Credit to Kirstin for both of these schematics</p>
      <div class="container">
        <div class="row">
          <div class="col-md-2">
          </div>
          <div class="col-md-4">
            <div class="thumbnail">
              <img src="img/lab4/Camera-to-Arduino_3V.jpg" style="width:100%">
              <div class="caption text-center">
                <p>Camera-to-Arduino power schematic</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="thumbnail">
              <img src="img/lab4/Camera-to-Arduino_I2C.png" style="width:65%">
              <div class="caption text-left">
                <p>Camera-to-Arduino I2C schematic</p>
              </div>
            </div>
          </div>
          <div class="col-md-2">
          </div>
        </div>
      </div>
      <h4 class="page-header text-left">Programming the Camera</h4>
      <ul>
        <li>The camera has control registers defined by their Serial Camera
          Control Bus (SCCB) interface</li>
        <li>We can use this interface via I2C from the Arduino</li>
        <li>Here are the control bits we need to set, and in which register
          (the format is REGISTER_NAME[bit_index], bits are 0-indexed):</li>
          <ul>
            <li>COM7[7] = 1	&nbsp &nbsp &nbsp	&nbsp &nbsp &nbsp ← SCCB register reset</li>
            <li>COM14[3] = 1 &nbsp &nbsp &nbsp	&nbsp &nbsp ← Enable Manual Resolution Scaling</li>
            <li>CLKRC[6] = 1 &nbsp &nbsp &nbsp	&nbsp &nbsp ← Use external clock</li>
            <li>COM7[3] = 1 &nbsp &nbsp &nbsp	&nbsp &nbsp &nbsp ← QCIF</li>
            <li>COM7[2],[0] = 10 &nbsp &nbsp	&nbsp← Output format - RGB selection</li>
            <li>COM15[4:3] = 01 &nbsp &nbsp &nbsp← RGB 565</li>
            <li>COM7[1] = 1 &nbsp &nbsp &nbsp	&nbsp &nbsp &nbsp ← color bar enable</li>
            <li>COM17[3] = 1 &nbsp &nbsp &nbsp &nbsp	&nbsp ← DSP color bar enable</li>
            <li>MVFP[5] = 1 &nbsp &nbsp &nbsp &nbsp	&nbsp &nbsp ← mirror image</li>
            <li>MVFP[4] = 1 &nbsp &nbsp &nbsp &nbsp	&nbsp  &nbsp ← vertically flip image</li>
          </ul>
        <li>The camera I2C slave addresses are found on page 10 of the camera datasheet</li>
        <ul>
          <li>0x42 = write address</li>
          <li>0x43 = read address</li>
          <li>NOTE - Arduino’s Wire library fills in the LSB based on whether we are reading or writing</li>
          <ul>
            <li>The actual address we use when calling the Wire library is 0x21 (the 7 MSB of the above slave addresses</li>
          </ul>
        </ul>
        <li>NOTE - all values will be read in hexadecimal format</li>
        <ul>
          <li>All addresses and write values should also be written in hex</li>
          <li>Be sure you specify that format in your code (eg. 0xAB)</li>
        </ul>
        <li>We used the provided read_register_value() function to create a function read_key_registers()</li>
        <ul>
          <li>We use this as a diagnostic tool to print out the values in all of the target registers</li>
          <li>It is the first function called, and then is called again after writing to the registers</li>
          <li>This allows us to compare the results to make sure we set the correct registers to the desired value</li>
        </ul>
      </ul>
      <div class="container">
        <div class="row">
          <div class="col-md-4">
          </div>
          <div class="col-md-4">
            <div class="thumbnail">
              <img src="img/lab4/Camera_Setup.png" style="width:100%">
              <div class="caption text-center">
                <p>Setting up the camera registers</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
          </div>
        </div>
      </div>
      <h4 class="page-header text-left">Creating FPGA-to-Camera Communication Scheme</h4>
      <ul>
        <li>For the competition, we need to be able to detect the following:</li>
        <ul>
          <li>Presence of a treasure</li>
          <li>Color detection - blue or red</li>
          <li>Shape detection - triangle, square, or circle</li>
        </ul>
        <li>We created the below table to encode this information into 1 byte</li>
        <ul>
          <li>Although we are using a full byte, the 7 possibilities fit into just 3 bits</li>
        </ul>
        <li>During the lab, we plan to send this over 3 parallel wires</li>
        <ul>
          <li>This is easier to setup</li>
          <li>Requires more pins, but we have plenty available on the extra Arduino Uno we are using</li>
        </ul>
        <li>During the competition, we plan to use software serial</li>
        <ul>
          <li>This is more challenging to setup</li>
          <li>Only requires two pins -> we only have two pins available</li>
        </ul>
      </ul>
      <div class="container">
        <div class="row">
          <div class="col-md-4">
          </div>
          <div class="col-md-4">
            <div class="thumbnail">
              <img src="img/lab4/FPGA-to-Camera Encoding.png" style="width:100%">
              <div class="caption text-center">
                <p>FPGA-to-Arduino communication scheme</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
          </div>
        </div>
      </div>
      <hr>

      <h3 class="page-header text-center">FPGA Team</h3>
      <p><u>GOAL: setup the FPGA to perform shape and color detection</u></p>
      <h4 class="page-header text-left">Materials Used</h4>
      <ul class="list-bullet">
      	<li>1 × <a target="_blank" href="https://www.terasic.com.tw/cgi-bin/page/archive_download.pl?Language=English&No=593&FID=75023fa36c9bf8639384f942e65a46f3">DE0-Nano Development and Education Board</a></li>
        <li>1 × GPIO-to-VGA adapter</li>
        <li>Altera Quartus Software</li>
      </ul>
    </div>



    <!-- Footer -->
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-md-3">
          </div>
          <div class="col-md-6">
            <span class="copyright">Copyright &copy; 2018, Team 21 of ECE 3400 | Fall 2018.
              <br>
              Theme Made Using <a target="_blank" href="http://getbootstrap.com">Bootstrap
            </span>
          </div>
          <div class="col-md-3">
            <ul class="list-inline quicklinks">
              <li class="list-inline-item">
                <a target="_blank" href="https://cei-lab.github.io/ece3400-2018/">ECE 3400 Course Page</a>
              </li>
            </ul>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4">
          </div>
          <div class="col-md-4">
            <ul class="list-inline social-buttons">
              <li class="list-inline-item">
                <a target="_blank" href="https://github.com/ECE3400-FA18-Group21/ECE3400-FA18-Group21.github.io/tree/master">
                  <i class="fab fa-github"></i>
                </a>
              </li>
            </ul>
          </div>
          <div class="col-md-4">
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Contact form JavaScript -->
    <script src="js/jqBootstrapValidation.js"></script>
    <script src="js/contact_me.js"></script>

    <!-- Custom scripts for this template -->
    <script src="js/agency.min.js"></script>

  </body>

</html>
